@using Codeer.LowCode.Blazor.ProCode;
@using Codeer.LowCode.Blazor.Repository.Data
@using LowCodeSamples.Client.Shared.Mapping.Data
@using Codeer.LowCode.Blazor.RequestInterfaces
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@inherits ProCodeComponentBase
@inject Services Services;

<div class="bubble-page">
    <div class="wrap">
        <header>
            <div>
                <h1>バブル（売上集計）</h1>
                <div class="hint">
                    合計金額で泡サイズを決める<br />
                </div>
            </div>
        </header>

        <section class="panel">
            <div class="field">
                <div class="bubbles" aria-label="bubble list">
                    @if (!FilteredSizedItems.Any())
                    {
                        <div class="empty">該当データがありません。</div>
                    }
                    else
                    {
                        @foreach (var x in FilteredSizedItems)
                        {
                            <div class="bubble @(x.Amount <= 0 ? "is-zero" : "")"
                                 style="--size:@($"{x.SizePx}px"); --dy:@Drift(x.Key); background:@x.Accent;"
                                 data-tip="@TipText(x)">
                                <div class="bubble__content">
                                    <div class="bubble__name">@x.Name</div>
                                    <div class="bubble__amount">¥@x.Amount.ToString("N0")</div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="legend">
                    <span><span class="dot" style="background:rgba(46,107,255,.55)"></span>上位(売上)</span>
                    <span><span class="dot" style="background:rgba(255,61,122,.55)"></span>中位</span>
                    <span><span class="dot" style="background:rgba(255,196,0,.55)"></span>下位</span>
                    <span><span class="dot" style="background:rgba(255,255,255,.92)"></span>データ不足/0</span>
                </div>
            </div>
        </section>
    </div>
</div>

@code
{
    private List<q_売上集計> SalesSummaryData { get; set; } = new();

    private string Query { get; set; } = "";
    private string SelectedSort { get; set; } = "amount-desc";
    private DateOnly Start { get; set; } = new DateOnly(2025, 12, 1);
    private DateOnly End { get; set; } = new DateOnly(2025, 12, 31);

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        SalesSummaryData = await Services.GetSalesSummaryData(Start, End) ?? new();
        StateHasChanged();
    }

    private IEnumerable<SalesBubble> SalesBubbles
        => (SalesSummaryData ?? new List<q_売上集計>())
            .Select(r => new SalesBubble(
                Name: GetText(r.商品名),
                Amount: GetNumber(r.合計金額),
                PeriodStart: GetDateOnly(r.期間開始日),
                PeriodEnd: GetDateOnly(r.期間終了日)
            ))
            .Where(x => !string.IsNullOrWhiteSpace(x.Name));

    private IEnumerable<SizedBubble> FilteredSizedItems
    {
        get
        {
            IEnumerable<SalesBubble> q = SalesBubbles;

            if (!string.IsNullOrWhiteSpace(Query))
            {
                var needle = Query.Trim().ToLowerInvariant();
                q = q.Where(x => (x.Name ?? "").ToLowerInvariant().Contains(needle));
            }

            q = SelectedSort switch
            {
                "amount-asc" => q.OrderBy(x => x.Amount),
                "name-asc" => q.OrderBy(x => x.Name, StringComparer.Create(CultureInfo.GetCultureInfo("ja-JP"), ignoreCase: false)),
                _ => q.OrderByDescending(x => x.Amount),
            };

            return ComputeSizes(q.ToList());
        }
    }

    private static string AmountAccent(decimal amount, double t)
    {
        if (amount <= 0) return "rgba(255,255,255,.92)";
        if (t >= 0.75) return "rgba(46,107,255,.55)";
        if (t >= 0.40) return "rgba(255,61,122,.55)";
        return "rgba(255,196,0,.55)";
    }

    private static string Drift(string key)
    {
        unchecked
        {
            uint h = 0;
            foreach (var ch in key ?? "")
                h = (h * 31) + ch;

            var r = (h % 1000) / 1000.0;
            var dy = (int)Math.Round((r - 0.5) * 22);
            return $"{dy}px";
        }
    }

    private static string TipText(SizedBubble x)
    {
        var p = PeriodText(x.PeriodStart, x.PeriodEnd);
        return string.IsNullOrWhiteSpace(p)
            ? $"{x.Name} / 合計:{x.Amount:N0}"
            : $"{x.Name} / 合計:{x.Amount:N0} / {p}";
    }

    private static string PeriodText(DateOnly? s, DateOnly? e)
    {
        if (s is null && e is null) return "";
        if (s is not null && e is not null) return $"期間:{s:yyyy/MM/dd}〜{e:yyyy/MM/dd}";
        if (s is not null) return $"期間開始:{s:yyyy/MM/dd}";
        return $"期間終了:{e:yyyy/MM/dd}";
    }

    private static string GetText(TextFieldData? f)
        => GetValueAsString(f) ?? "";

    private static decimal GetNumber(NumberFieldData? f)
    {
        var obj = GetValueObject(f);
        if (obj is null) return 0m;

        if (obj is decimal d) return d;
        if (obj is double db) return (decimal)db;
        if (obj is float fl) return (decimal)fl;
        if (obj is int i) return i;
        if (obj is long l) return l;

        if (obj is string s && decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var parsed))
            return parsed;

        try
        {
            return Convert.ToDecimal(obj, CultureInfo.InvariantCulture);
        }
        catch
        {
            return 0m;
        }
    }

    private static DateOnly? GetDateOnly(DateFieldData? f)
    {
        var obj = GetValueObject(f);
        if (obj is null) return null;

        if (obj is DateOnly d) return d;
        if (obj is DateTime dt) return DateOnly.FromDateTime(dt);
        if (obj is DateTimeOffset dto) return DateOnly.FromDateTime(dto.DateTime);

        if (obj is string s)
        {
            if (DateOnly.TryParse(s, out var dd)) return dd;
            if (DateTime.TryParse(s, out var ddt)) return DateOnly.FromDateTime(ddt);
        }

        return null;
    }

    private static object? GetValueObject(object? field)
    {
        if (field is null) return null;
        var prop = field.GetType().GetProperty("Value");
        return prop?.GetValue(field);
    }

    private static string? GetValueAsString(object? field)
        => GetValueObject(field)?.ToString();

    private sealed record SalesBubble(string Name, decimal Amount, DateOnly? PeriodStart, DateOnly? PeriodEnd)
    {
        public string Key => Name;
    }

    private static IEnumerable<SizedBubble> ComputeSizes(IReadOnlyList<SalesBubble> items)
    {
        if (items.Count == 0) return Array.Empty<SizedBubble>();

        var min = items.Min(x => x.Amount);
        var max = items.Max(x => x.Amount);

        const int Smin = 86, Smax = 190;

        return items.Select(x =>
        {
            var t = (max == min) ? 0.5 : (double)((x.Amount - min) / (max - min));
            t = Math.Clamp(t, 0.0, 1.0);

            var eased = Math.Pow(t, 0.75);
            var size = (int)Math.Round(Smin + (Smax - Smin) * eased);

            var accent = AmountAccent(x.Amount, t);

            return new SizedBubble(x, size, accent);
        });
    }

    private sealed record SizedBubble(SalesBubble Item, int SizePx, string Accent)
    {
        public string Name => Item.Name;
        public string Key => Item.Key;
        public decimal Amount => Item.Amount;
        public DateOnly? PeriodStart => Item.PeriodStart;
        public DateOnly? PeriodEnd => Item.PeriodEnd;
    }

}
